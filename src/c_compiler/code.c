#include "globals.h"
#include "code.h"

/* TM location number for current instruction emission */
// 记录当前位置/当前行号
static int emitLoc = 0;

/* Highest TM location emitted so far
   For use in conjunction with emitSkip,
   emitBackup, and emitRestore */
// 记录最高行号，用于emitRestore函数
static int highEmitLoc = 0;

/* Procedure emitComment prints a comment line
 * with comment c in the code file
 */
// 用于打印调试信息
void emitComment(char *c)
{
  if (TraceCode)
    fprintf(code, "* %s\n", c);
}

/* Procedure emitRO emits a register-only
 * TM instruction
 * op = the opcode
 * r = target register
 * s = 1st source register
 * t = 2nd source register
 * c = a comment to be printed if TraceCode is TRUE
 */
void emitRO(char *op, int r, int s, int t, char *c)
{
  fprintf(code, "%3d:  %5s  %d,%d,%d ", emitLoc++, op, r, s, t);
  if (TraceCode)
    fprintf(code, "\t%s", c);
  fprintf(code, "\n");
  if (highEmitLoc < emitLoc)
    highEmitLoc = emitLoc;
} /* emitRO */

/* Procedure emitRM emits a register-to-memory
 * TM instruction
 * op = the opcode
 * r = target register
 * d = the offset
 * s = the base register
 * c = a comment to be printed if TraceCode is TRUE
 */
void emitRM(char *op, int r, int d, int s, char *c)
{
  fprintf(code, "%3d:  %5s  %d,%d(%d) ", emitLoc++, op, r, d, s);
  if (TraceCode)
    fprintf(code, "\t%s", c);
  fprintf(code, "\n");
  if (highEmitLoc < emitLoc)
    highEmitLoc = emitLoc;
} /* emitRM */

/* Function emitSkip skips "howMany" code
 * locations for later backpatch. It also
 * returns the current code position
 */
// 留空
int emitSkip(int howMany)
{
  int i = emitLoc;
  emitLoc += howMany;
  if (highEmitLoc < emitLoc)
    highEmitLoc = emitLoc;
  return i;
} /* emitSkip */

/* Procedure emitBackup backs up to
 * loc = a previously skipped location
 */
// 回填
void emitBackup(int loc)
{
  if (loc > highEmitLoc)
    emitComment("BUG in emitBackup");
  emitLoc = loc;
} /* emitBackup */

/* Procedure emitRestore restores the current
 * code position to the highest previously
 * unemitted position
 */
// 回填后再回到当前位置
void emitRestore(void)
{
  emitLoc = highEmitLoc;
}

/* Procedure emitRM_Abs converts an absolute reference
 * to a pc-relative reference when emitting a
 * register-to-memory TM instruction
 * op = the opcode
 * r = target register
 * a = the absolute location in memory
 * c = a comment to be printed if TraceCode is TRUE
 */
// 使用该函数的原因是：没有zero寄存器，只能迂回实现
void emitRM_Abs(char *op, int r, int a, char *c)
{
  fprintf(code, "%3d:  %5s  %d,%d(%d) ",
          emitLoc, op, r, a - (emitLoc + 1), pc); // 绝对地址先转成相对地址，因为最终还是要和pc相加
  ++emitLoc;
  if (TraceCode)
    fprintf(code, "\t%s", c);
  fprintf(code, "\n");
  if (highEmitLoc < emitLoc)
    highEmitLoc = emitLoc;
} /* emitRM_Abs */
